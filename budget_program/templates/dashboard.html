<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { color: white; margin-bottom: 30px; text-align: center; }
        h1 { font-size: 2.2em; margin-bottom: 10px; }
        .nav-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        button {
            background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 5px;
            cursor: pointer; font-weight: bold; transition: all 0.3s ease;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .card h2 { color: #667eea; margin-bottom: 15px; font-size: 1.3em; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .card-item { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .card-item:last-child { border-bottom: none; }
        .card-label { font-weight: 500; color: #333; }
        .card-value { color: #667eea; font-weight: bold; font-size: 1.05em; white-space: nowrap; }
        .card-value.positive { color: #27ae60; }
        .card-value.negative { color: #e74c3c; }
        .card-value.clickable { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .total-card { grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .total-card h2 { color: white; border-color: white; }
        .total-card .card-label { color: rgba(255, 255, 255, 0.8); }
        .total-card .card-value { color: #4ade80; }
        .total-card .card-value.negative { color: #f87171; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        label { font-weight: 500; color: #333; margin-bottom: 5px; font-size: 0.9em; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1em; }
        input:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .form-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-small { font-size: 0.85em; padding: 7px 10px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); }
        .modal.active { display: flex; }
        .modal-content { background-color: white; margin: auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 560px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .modal-content h2 { color: #667eea; margin-bottom: 20px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .category-item { background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .category-item.overspent { border-left: 4px solid #e74c3c; }
        .progress-bar { background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden; margin-top: 5px; }
        .progress-fill { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease; }
        .refresh-btn { background: #667eea; color: white; }
        .loading { text-align: center; padding: 40px; color: white; font-size: 1.2em; }
        .expense-meta { font-size: 0.85em; color: #666; margin-top: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Budget Dashboard</h1>
            <div class="nav-buttons">
                <button class="refresh-btn" onclick="loadDashboard()">Refresh</button>
                <button onclick="openAddAccountModal()">+ Account</button>
                <button onclick="openAddDebtModal()">+ Debt</button>
                <button onclick="openAddPaycheckModal()">+ Paycheck</button>
                <button onclick="openAddExpenseModal()">+ Expense</button>
            </div>
        </header>

        <div id="alert-container"></div>
        <div id="dashboard-content" class="loading">Loading dashboard...</div>
    </div>

    <div id="accountModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('accountModal')">&times;</span><h2>Add Account</h2>
        <div class="form-group"><label>Account Name *</label><input type="text" id="accountName" placeholder="e.g., Checking"></div>
        <div class="form-group"><label>Institution</label><input type="text" id="accountInstitution" placeholder="e.g., Chase"></div>
        <div class="form-group"><label>Type *</label><select id="accountType"><option>checking</option><option>savings</option><option>hysa</option><option>401k</option><option>roth</option><option>brokerage</option><option>cash</option></select></div>
        <div class="form-group"><label>Current Balance *</label><input type="number" id="accountBalance" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Interest Rate (%)</label><input type="number" id="accountRate" step="0.01" placeholder="0.00"></div>
        <div class="form-actions"><button class="btn-primary" onclick="saveAccount()">Save</button><button class="btn-secondary" onclick="closeModal('accountModal')">Cancel</button></div>
    </div></div>

    <div id="debtModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('debtModal')">&times;</span><h2>Add Debt</h2>
        <div class="form-group"><label>Debt Name *</label><input type="text" id="debtName" placeholder="e.g., Credit Card"></div>
        <div class="form-group"><label>Institution/Person</label><input type="text" id="debtInstitution" placeholder="e.g., Capital One"></div>
        <div class="form-group"><label>Type *</label><select id="debtType"><option>personal</option><option>credit_card</option><option>loan</option><option>medical</option></select></div>
        <div class="form-group"><label>Current Balance *</label><input type="number" id="debtBalance" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Interest Rate (%)</label><input type="number" id="debtRate" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Min Payment</label><input type="number" id="debtMinPayment" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Due Day (1-31)</label><input type="number" id="debtDueDay" min="1" max="31" placeholder="15"></div>
        <div class="form-actions"><button class="btn-primary" onclick="saveDebt()">Save</button><button class="btn-secondary" onclick="closeModal('debtModal')">Cancel</button></div>
    </div></div>

    <div id="paycheckModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('paycheckModal')">&times;</span><h2>Add Paycheck</h2>
        <div class="form-group"><label>Amount *</label><input type="number" id="paycheckAmount" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Date</label><input type="date" id="paycheckDate"></div>
        <div class="form-group"><label>Note</label><input type="text" id="paycheckNote" placeholder="Optional note"></div>
        <div class="form-actions"><button class="btn-primary" onclick="savePaycheck()">Save</button><button class="btn-secondary" onclick="closeModal('paycheckModal')">Cancel</button></div>
    </div></div>

    <div id="expenseModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('expenseModal')">&times;</span><h2>Add Expense</h2>
        <div class="form-group"><label>Amount *</label><input type="number" id="expenseAmount" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Category *</label><select id="expenseCategory"></select></div>
        <div class="form-group"><label>Date</label><input type="date" id="expenseDate"></div>
        <div class="form-group"><label>Note</label><input type="text" id="expenseNote" placeholder="Optional note"></div>
        <div class="form-group"><label>Tags</label><input type="text" id="expenseTags" placeholder="e.g., groceries, food"></div>
        <div class="form-actions"><button class="btn-primary" onclick="saveExpense()">Save</button><button class="btn-secondary" onclick="closeModal('expenseModal')">Cancel</button></div>
    </div></div>

    <div id="allocateModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('allocateModal')">&times;</span><h2>Allocate or Transfer</h2>
        <input type="hidden" id="allocateAccountId">
        <div class="form-group"><label id="allocateSourceLabel">Source Account</label></div>
        <div class="form-group"><label>Target Type *</label><select id="allocTargetType" onchange="populateAllocationTargetOptions()"><option value="expense">Unpaid Expense</option><option value="debt">Debt</option></select></div>
        <div class="form-group"><label>Target *</label><select id="allocTarget"></select></div>
        <div class="form-group"><label>Amount *</label><input type="number" id="allocAmount" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Date</label><input type="date" id="allocDate"></div>
        <div class="form-group"><label>Note</label><input type="text" id="allocNote" placeholder="Optional note"></div>
        <div class="form-actions"><button class="btn-primary" onclick="saveAllocation()">Allocate</button><button class="btn-secondary" onclick="closeModal('allocateModal')">Cancel</button></div>
    </div></div>

    <script>
        let dashboardData = null;

        document.getElementById('paycheckDate').valueAsDate = new Date();
        document.getElementById('expenseDate').valueAsDate = new Date();
        document.getElementById('allocDate').valueAsDate = new Date();

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function populateCategoryDropdown(categories) {
            const select = document.getElementById('expenseCategory');
            select.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.parent_id ? `- ${cat.name}` : cat.name;
                select.appendChild(option);
            });
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();
                dashboardData = data;
                renderDashboard(data);
                populateCategoryDropdown(data.all_categories || []);
            } catch (error) {
                showAlert('Error loading dashboard: ' + error, 'error');
            }
        }

        function renderDashboard(data) {
            const html = `
                <div class="grid">
                    <div class="card total-card">
                        <h2>Summary</h2>
                        <div class="card-item"><span class="card-label">Total Accounts</span><span class="card-value positive">$${Number(data.totals.accounts).toFixed(2)}</span></div>
                        <div class="card-item"><span class="card-label">Total Debts</span><span class="card-value negative">$${Number(data.totals.debts).toFixed(2)}</span></div>
                        <div class="card-item"><span class="card-label">Net Worth</span><span class="card-value ${Number(data.totals.net_worth) >= 0 ? 'positive' : 'negative'}">$${Number(data.totals.net_worth).toFixed(2)}</span></div>
                    </div>
                    ${renderAccounts(data.accounts)}
                    ${renderDebts(data.debts)}
                    ${renderCategories(data.categories)}
                    ${renderRecentExpenses(data.recent_expenses || [], data.all_categories || [])}
                    ${renderGoals(data.goals)}
                </div>
            `;
            document.getElementById('dashboard-content').innerHTML = html;
        }
        function renderAccounts(accounts) {
            if (!accounts || accounts.length === 0) return '<div class="card"><h2>Accounts</h2><p>(none)</p></div>';
            let html = '<div class="card"><h2>Accounts</h2>';
            accounts.forEach(acc => {
                html += `
                    <div class="card-item">
                        <span class="card-label">${acc.name} (${acc.type})</span>
                        <span class="card-value positive clickable" onclick="openAllocateModal(${acc.id})">$${Number(acc.balance).toFixed(2)}</span>
                    </div>
                `;
            });
            html += '<div class="expense-meta">Click an account balance to allocate/transfer to an unpaid expense or debt.</div>';
            html += '</div>';
            return html;
        }

        function renderDebts(debts) {
            if (!debts || debts.length === 0) return '<div class="card"><h2>Debts</h2><p>(none)</p></div>';
            let html = '<div class="card"><h2>Debts</h2>';
            debts.forEach(debt => {
                html += `
                    <div class="card-item">
                        <span class="card-label">${debt.name} (${debt.type})</span>
                        <span class="card-value negative">$${Number(debt.balance).toFixed(2)}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderCategories(categories) {
            const topLevel = (categories || []).filter(c => !c.parent_id);
            if (topLevel.length === 0) return '<div class="card"><h2>Categories</h2><p>(none)</p></div>';
            let html = '<div class="card" style="grid-column: 1 / -1;"><h2>Category Balances</h2>';
            topLevel.forEach(cat => {
                const pctUsed = Number(cat.allocated) > 0 ? (Number(cat.spent) / Number(cat.allocated)) * 100 : 0;
                const status = cat.overspent ? 'OVERSPENT' : '';
                html += `
                    <div class="category-item ${cat.overspent ? 'overspent' : ''}">
                        <div class="card-item">
                            <span class="card-label">${cat.name} (${Number(cat.allocation_pct).toFixed(2)}%)</span>
                            <span class="card-value">$${Number(cat.available).toFixed(2)} available ${status}</span>
                        </div>
                        <div class="expense-meta">Allocated: $${Number(cat.allocated).toFixed(2)} | Spent: $${Number(cat.spent).toFixed(2)}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${Math.min(pctUsed, 100)}%"></div></div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderRecentExpenses(expenses, categories) {
            if (!expenses || expenses.length === 0) {
                return '<div class="card" style="grid-column: 1 / -1;"><h2>Recent Expenses</h2><p>(none)</p></div>';
            }

            const categoryOptions = (selectedId) => categories.map(cat => {
                const selected = Number(cat.id) === Number(selectedId) ? 'selected' : '';
                const label = cat.parent_id ? `- ${cat.name}` : cat.name;
                return `<option value="${cat.id}" ${selected}>${label}</option>`;
            }).join('');

            let html = '<div class="card" style="grid-column: 1 / -1;"><h2>Recent Expenses</h2>';
            expenses.forEach(exp => {
                const remaining = Number(exp.remaining || 0);
                html += `
                    <div class="category-item">
                        <div class="card-item">
                            <span class="card-label">${exp.date} - $${Number(exp.amount).toFixed(2)} (${exp.category_name || 'N/A'})</span>
                            <span class="card-value ${remaining <= 0 ? 'positive' : 'negative'}">${remaining <= 0 ? 'Paid' : 'Open'} ($${remaining.toFixed(2)} left)</span>
                        </div>
                        <div class="expense-meta">Paid: $${Number(exp.paid_amount || 0).toFixed(2)} | ${exp.note || ''}</div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
                            <label style="margin: 0;">Category:</label>
                            <select id="expense-category-${exp.id}">${categoryOptions(exp.category_id)}</select>
                            <button class="btn-primary btn-small" onclick="updateExpenseCategory(${exp.id})">Update</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderGoals(goals) {
            if (!goals || goals.length === 0) return '';
            let html = '<div class="card" style="grid-column: 1 / -1;"><h2>Goals</h2>';
            goals.forEach(goal => {
                const pctProgress = Number(goal.target_amount) > 0 ? (Number(goal.current_amount) / Number(goal.target_amount)) * 100 : 0;
                html += `
                    <div class="category-item">
                        <div class="card-item">
                            <span class="card-label">${goal.name} (${goal.type})</span>
                            <span class="card-value">$${Number(goal.current_amount).toFixed(2)} / $${Number(goal.target_amount).toFixed(2)}</span>
                        </div>
                        <div class="expense-meta">Remaining: $${Number(goal.remaining).toFixed(2)} | ${goal.days_remaining} days left</div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${Math.min(pctProgress, 100)}%"></div></div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function openAddAccountModal() { openModal('accountModal'); }
        function openAddDebtModal() { openModal('debtModal'); }
        function openAddPaycheckModal() { openModal('paycheckModal'); }
        function openAddExpenseModal() {
            if (dashboardData) { populateCategoryDropdown(dashboardData.all_categories || []); }
            openModal('expenseModal');
        }

        function openAllocateModal(accountId) {
            if (!dashboardData) return;
            const account = (dashboardData.accounts || []).find(a => Number(a.id) === Number(accountId));
            if (!account) return showAlert('Account not found', 'error');
            document.getElementById('allocateAccountId').value = account.id;
            document.getElementById('allocateSourceLabel').textContent = `${account.name} (${account.type}) available: $${Number(account.balance).toFixed(2)}`;
            document.getElementById('allocAmount').value = '';
            document.getElementById('allocNote').value = '';
            document.getElementById('allocDate').valueAsDate = new Date();
            document.getElementById('allocTargetType').value = 'expense';
            populateAllocationTargetOptions();
            openModal('allocateModal');
        }

        function populateAllocationTargetOptions() {
            const select = document.getElementById('allocTarget');
            const targetType = document.getElementById('allocTargetType').value;
            select.innerHTML = '';
            if (!dashboardData) return;

            if (targetType === 'expense') {
                const pending = dashboardData.pending_expenses || [];
                if (pending.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No unpaid expenses';
                    select.appendChild(opt);
                    return;
                }
                pending.forEach(exp => {
                    const opt = document.createElement('option');
                    opt.value = `expense:${exp.id}`;
                    opt.textContent = `${exp.date} | ${exp.category_name || 'Expense'} | Remaining $${Number(exp.remaining).toFixed(2)}`;
                    select.appendChild(opt);
                });
                return;
            }

            const debts = (dashboardData.debts || []).filter(d => Number(d.balance) > 0);
            if (debts.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No open debts';
                select.appendChild(opt);
                return;
            }
            debts.forEach(debt => {
                const opt = document.createElement('option');
                opt.value = `debt:${debt.id}`;
                opt.textContent = `${debt.name} (${debt.type}) | Balance $${Number(debt.balance).toFixed(2)}`;
                select.appendChild(opt);
            });
        }
        async function saveAllocation() {
            const accountId = Number(document.getElementById('allocateAccountId').value);
            const targetRaw = document.getElementById('allocTarget').value;
            const amount = Number(document.getElementById('allocAmount').value);
            const allocDate = document.getElementById('allocDate').value;
            const note = document.getElementById('allocNote').value;
            if (!accountId || !targetRaw || !amount) {
                showAlert('Account, target, and amount are required', 'error');
                return;
            }

            const [targetType, targetIdRaw] = targetRaw.split(':');
            const targetId = Number(targetIdRaw);
            try {
                const response = await fetch('/api/allocations/account', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: accountId, target_type: targetType, target_id: targetId, amount, date: allocDate, note })
                });
                const result = await response.json();
                if (!response.ok) return showAlert('Error: ' + result.error, 'error');
                showAlert('Allocation completed!');
                closeModal('allocateModal');
                loadDashboard();
            } catch (error) {
                showAlert('Error saving allocation: ' + error, 'error');
            }
        }

        async function updateExpenseCategory(expenseId) {
            const select = document.getElementById(`expense-category-${expenseId}`);
            if (!select) return;
            const categoryId = Number(select.value);
            try {
                const response = await fetch(`/api/expenses/${expenseId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_id: categoryId })
                });
                const result = await response.json();
                if (!response.ok) return showAlert('Error: ' + result.error, 'error');
                showAlert('Expense category updated');
                loadDashboard();
            } catch (error) {
                showAlert('Error updating expense: ' + error, 'error');
            }
        }

        async function saveAccount() {
            const data = {
                name: document.getElementById('accountName').value,
                institution: document.getElementById('accountInstitution').value,
                type: document.getElementById('accountType').value,
                balance: document.getElementById('accountBalance').value,
                interest_rate: document.getElementById('accountRate').value,
            };
            if (!data.name || !data.balance) return showAlert('Name and balance are required', 'error');
            try {
                const response = await fetch('/api/accounts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) throw new Error('Unable to add account');
                showAlert('Account added!');
                closeModal('accountModal');
                loadDashboard();
                document.getElementById('accountName').value = '';
                document.getElementById('accountInstitution').value = '';
                document.getElementById('accountBalance').value = '';
                document.getElementById('accountRate').value = '';
            } catch (error) {
                showAlert('Error saving account: ' + error, 'error');
            }
        }

        async function saveDebt() {
            const data = {
                name: document.getElementById('debtName').value,
                institution: document.getElementById('debtInstitution').value,
                type: document.getElementById('debtType').value,
                balance: document.getElementById('debtBalance').value,
                interest_rate: document.getElementById('debtRate').value,
                min_payment: document.getElementById('debtMinPayment').value,
                due_day: document.getElementById('debtDueDay').value,
            };
            if (!data.name || !data.balance) return showAlert('Name and balance are required', 'error');
            try {
                const response = await fetch('/api/debts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) throw new Error('Unable to add debt');
                showAlert('Debt added!');
                closeModal('debtModal');
                loadDashboard();
                document.getElementById('debtName').value = '';
                document.getElementById('debtInstitution').value = '';
                document.getElementById('debtBalance').value = '';
            } catch (error) {
                showAlert('Error saving debt: ' + error, 'error');
            }
        }

        async function savePaycheck() {
            const data = {
                amount: document.getElementById('paycheckAmount').value,
                date: document.getElementById('paycheckDate').value,
                note: document.getElementById('paycheckNote').value,
            };
            if (!data.amount) return showAlert('Amount is required', 'error');
            try {
                const response = await fetch('/api/paycheck', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await response.json();
                if (!response.ok) return showAlert('Error: ' + result.error, 'error');
                showAlert('Paycheck added and allocated!');
                closeModal('paycheckModal');
                loadDashboard();
                document.getElementById('paycheckAmount').value = '';
                document.getElementById('paycheckNote').value = '';
            } catch (error) {
                showAlert('Error saving paycheck: ' + error, 'error');
            }
        }

        async function saveExpense() {
            const data = {
                amount: document.getElementById('expenseAmount').value,
                category_id: document.getElementById('expenseCategory').value,
                date: document.getElementById('expenseDate').value,
                note: document.getElementById('expenseNote').value,
                tags: document.getElementById('expenseTags').value,
            };
            if (!data.amount || !data.category_id) return showAlert('Amount and category are required', 'error');
            try {
                const response = await fetch('/api/expense', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await response.json();
                if (!response.ok) return showAlert('Error: ' + result.error, 'error');
                showAlert('Expense added!');
                closeModal('expenseModal');
                loadDashboard();
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseNote').value = '';
                document.getElementById('expenseTags').value = '';
            } catch (error) {
                showAlert('Error saving expense: ' + error, 'error');
            }
        }

        window.addEventListener('load', () => {
            fetch('/api/dashboard')
                .then(r => r.json())
                .then(data => {
                    if (data.categories && data.categories.length > 0) {
                        dashboardData = data;
                        renderDashboard(data);
                        populateCategoryDropdown(data.all_categories || []);
                    } else {
                        window.location.href = '/setup';
                    }
                })
                .catch(error => showAlert('Error loading dashboard: ' + error, 'error'));
        });
    </script>
</body>
</html>
